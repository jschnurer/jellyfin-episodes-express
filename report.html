<html>

<head>
  <style>
    body,
    html {
      margin: 0;
      padding: 1em;
      background-color: #222;
      color: #ccc;
      font-family: sans-serif;
    }

    body {
      display: flex;
      flex-direction: column;
      gap: 1em;
    }

    .page {
      margin: auto;
      max-width: 50em;
    }

    .header {
      display: flex;
      flex-direction: column;
      gap: 1em;
    }

    a {
      color: white;
    }

    a:visited {
      color: gray;
    }

    h1,
    h2 {
      font-style: italic;
      margin-bottom: .2em;
    }

    .body {
      border: 1px #ccc solid;
      padding: .5em;
      display: flex;
      flex-direction: column;
      position: relative;
    }

    .body .expander {
      display: none;
    }

    .body.closed {
      max-height: 1em;
      overflow: hidden;
    }

    .body.closed .expander {
      display: block;
      position: absolute;
      inset: 0 0 0 0;
      background-color: black;
      opacity: .85;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      cursor: pointer;
    }

    .show-row {
      display: flex;
      border-bottom: 1px dotted #ccc;
      padding: .5em 0;
      align-items: center;
    }

    .show-row:hover {
      background-color: #333;
    }

    .hide-show {
      display: inline-block;
      margin-right: 1em;
      cursor: pointer;
      font-size: 1.25em;
      line-height: .5em;
    }

    .clickable {
      cursor: pointer;
    }

    .hide-show:hover,
    .clickable:hover {
      color: red;
    }

    .show {
      flex: auto;
    }

    .recount-modal {
      display: none;
      position: fixed;
      inset: 0 0 0 0;
      align-items: center;
      justify-content: center;
    }

    .recount-dark {
      background-color: rgba(0, 0, 0, .75);
      position: fixed;
      inset: 0 0 0 0;
    }

    .recount-form {
      background-color: #333;
      border: 2px silver solid;
      padding: 1em;
      z-index: 1;
      display: flex;
      flex-direction: column;
      gap: 1em;
      max-width: 600px;
    }

    .recount-form label {
      font-weight: bold;
    }

    #recount-show-name {
      font-size: 1.5em;
    }

    .ep {
      display: flex;
      gap: .25em;
    }

    .overridden-episode {
      font-style: italic;
      color: yellow;
      cursor: help;
    }

    button {
      background-color: white;
      padding: .25em .5em;
      color: black;
      border: none;
      opacity: .8;
      cursor: pointer;
    }

    button:hover {
      opacity: 1;
    }
  </style>

  <script src="https://code.jquery.com/jquery-3.7.0.slim.min.js"
    integrity="sha256-tG5mcZUtJsZvyKAxYLVXrmjKBVLd6VpVccqz/r4ypFE=" crossorigin="anonymous"></script>

  <script lang="javascript">
    var epLinkPattern = "#epLink#";

    var linkDict = #linkDict#;

    var recountOverrides = #recountOverrides#;

    var showData = #outputJson#;
  </script>

  <script lang="javascript">
    $(function () {
      // Body on load.
      var shows = showData.shows;

      $("#last-run-date").text(new Date(showData.lastRun));

      appendAvailableEpisodes(shows.filter(x => x.status === "available"));
      appendUpcomingEpisodes(shows.filter(x => x.status === "upcoming"));
      appendEndedShows(shows.filter(x => x.status === "ended"));
      appendLastRunErrors(showData.lastRunErrors);
      appendIgnoredShows(shows.filter(x => x.status === "ignored"));

      setupClickEvents();
    });

    function appendAvailableEpisodes(shows) {
      var bodyDiv = $("#available-episodes");
      var sortedShows = shows
        .sort((a, b) => a.show < b.show ? -1 : 1);

      sortedShows
        .forEach(show => {
          var div = $("<div>", {
            class: "show-row",
          }).appendTo(bodyDiv);

          var hideSpan = $("<span>", {
            class: "hide-show",
            title: "Ignore Show",
          }).appendTo(div);

          hideSpan.attr("data-action", "ignore");
          hideSpan.attr("data-jellyfin-id", show.jellyfinId);
          hideSpan.attr("data-show", show.show);
          hideSpan.text("üëÅ");

          var showSpan = $("<span>", {
            class: "show",
          }).appendTo(div);

          var epSpan = $("<span>", {
            class: "ep",
          }).appendTo(div);

          showSpan.append(show.show);
          epSpan.append(show.jellyfinLatestEpisode + " ‚Üí ");

          epSpan.append(show.availableEpisode + ": ");

          appendEpLinks(show.show, show.jellyfinId, show.availableEpisode, epSpan);

          getRecountLinkForShow(show).appendTo(epSpan);
        });
    }

    function appendUpcomingEpisodes(shows) {
      var bodyDiv = $("#upcoming-episodes");

      groupBy(shows, "upcomingEpisodeAirDate")
        .sort((a, b) => a.key < b.key ? -1 : 1)
        .forEach(group => {
          var upcomingEpisodeAirDate = group.key;
          var showsOnThisDate = group.values;

          // Create a header inside the body for this date.
          var header = $("<h2>").appendTo(bodyDiv);
          header.text(formatTMDBDate(upcomingEpisodeAirDate) + ` (${getDaysTil(strToDate(group.key))})`);

          // Now output the list of shows.
          var sortedShows = showsOnThisDate
            .sort((a, b) => a.show < b.show ? -1 : 1);

          sortedShows
            .forEach(show => {
              var div = $("<div>", {
                class: "show-row",
              }).appendTo(bodyDiv);

              var showSpan = $("<span>", {
                class: "show",
              }).appendTo(div);

              var epSpan = $("<span>", {
                class: "ep",
              }).appendTo(div);

              var hideSpan = $("<span>", {
                class: "hide-show",
                title: "Ignore Show",
              }).appendTo(showSpan);

              hideSpan.attr("data-jellyfin-id", show.jellyfinId);
              hideSpan.text("üëÅ");

              showSpan.append(show.show);
              epSpan.append(show.jellyfinLatestEpisode + " ‚Üí ");

              var nextEpSpan = $("<span>").appendTo(epSpan);
              nextEpSpan.append(show.upcomingEpisode);

              // Get the overridden episode (if any).
              var overrideEp = getOverriddenEp(show.show, show.jellyfinId, show.upcomingEpisode);

              if (overrideEp !== show.upcomingEpisode) {
                var epOverrideSpan = $("<span>", {
                  class: "overridden-episode",
                  title: "This show has an episode recount override."
                }).appendTo(epSpan);
                epOverrideSpan.append("(" + overrideEp + ")");
              }

              appendEpLinks(show.show, show.jellyfinId, show.upcomingEpisode, epSpan);

              getRecountLinkForShow(show).appendTo(epSpan);
            });
        });
    }

    function appendEpLinks(showName, showId, episode, parentEl) {
      let i = 0;
      Object.entries(linkDict).map(entry => {
        var linkSpan = $("<a>", {
          class: "ep-link",
        }).appendTo(parentEl);

        var overriddenEp = getOverriddenEp(showName, showId, episode);
        linkSpan.attr("href", entry[1].replace("{search}", showName + " " + overriddenEp));
        linkSpan.append(entry[0]);
        i++;
      });
    }

    /// Uses the recount overrides to get the "true" episode number. Otherwise, returns the original episode number.
    function getOverriddenEp(showName, jellyfinId, episode) {
      // episode is like "S02E06".
      // use override to change this based on the season ep counts provided.
      var override = recountOverrides.find(x => x.id === jellyfinId)?.recountOverride;

      if (!override) {
        return episode;
      }

      try {
        var numPrevEps = override.split(",").map(x => Number(x)).reduce((a, b) => a + b, 0);
        var newEpNumber = Number(episode.split("E")[1]);

        // E.g. new one is S01E29. But really, that's S02E01. Since 28 eps are in season 1
        // and we summed them to get 28, we can do NewEp (29) minus sum (28) = 1.
        // Then we just take the count of override season counts (1), add 1 to get the
        // new season number (2), then use the result of the first sum as the episode num.
        var realEpNumber = newEpNumber - numPrevEps;
        var realSeasonNumber = override.split(",").length + 1;
        return `S${realSeasonNumber.toString().padStart(2, "0")}E${realEpNumber.toString().padStart(2, "0")}`;
      } catch (err) {
        console.error(`Failed to handle episode recount override for "${showName}"!`, err);
      }
    }

    function appendEndedShows(shows) {
      var bodyDiv = $("#ended-shows");

      var sortedShows = shows
        .sort((a, b) => a.show < b.show ? -1 : 1);

      sortedShows
        .forEach(show => {
          var div = $("<div>", {
            class: "show-row",
          }).appendTo(bodyDiv);

          var showSpan = $("<span>", {
            class: "show",
          }).appendTo(div);

          showSpan.append(show.show);
        });
    }

    function appendLastRunErrors(errorMessages) {
      var bodyDiv = $("#last-run-errors");

      errorMessages
        .forEach(msg => {
          var div = $("<div>", {
            class: "show-row",
          }).appendTo(bodyDiv);

          var hideSpan = $("<span>", {
            class: "hide-show",
            title: "Ignore Show",
          }).appendTo(div);

          hideSpan.attr("data-action", "ignore");
          hideSpan.attr("data-jellyfin-id", msg.jellyfinId);
          hideSpan.attr("data-show", msg.show);
          hideSpan.text("üëÅ");

          var showSpan = $("<span>", {
            class: "show",
          }).appendTo(div);
          showSpan.text(msg.show)

          var errSpan = $("<span>", {
            class: "error-message",
          }).appendTo(div);
          errSpan.text(msg.error)

          div.append(msg);
        });
    }

    function appendIgnoredShows(shows) {
      var bodyDiv = $("#ignored-shows");

      var sortedShows = shows
        .sort((a, b) => a.show < b.show ? -1 : 1);

      sortedShows
        .forEach(show => {
          var div = $("<div>", {
            class: "show-row",
          }).appendTo(bodyDiv);

          var showSpan = $("<span>", {
            class: "show",
          }).appendTo(div);

          var unhideSpan = $("<span>", {
            class: "hide-show",
            title: "Ignore Show",
          }).appendTo(showSpan);

          unhideSpan.attr("data-action", "unignore");
          unhideSpan.attr("data-jellyfin-id", show.jellyfinId);
          unhideSpan.attr("data-show", show.show);
          unhideSpan.text("üëÅ");

          showSpan.append(show.show);
        });
    }

    function groupBy(xs, key) {
      return xs.reduce(function (rv, x) {
        let v = key instanceof Function
          ? key(x)
          : x[key];
        let el = rv.find((r) => r && r.key === v);
        if (el) {
          el.values.push(x);
        } else {
          rv.push({
            key: v,
            values: [x],
          });
        }
        return rv;
      },
        []);
    }

    function getRecountLinkForShow(show) {
      // Setup the "season override thing" for links.
      var editCountingSpan = $("<span>", {
        class: "clickable edit-counting",
      });

      editCountingSpan.attr("data-jellyfin-id", show.jellyfinId);
      editCountingSpan.attr("data-show", show.show);
      editCountingSpan.attr("title", "Edit this show's episode counting method to override torrent links (e.g. 1x14 -> 2x02).");
      editCountingSpan.append("‚úé");

      return editCountingSpan;
    }

    const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

    function strToDate(dateStr) {
      const parts = dateStr.split("-");
      return new Date(parts[0], parts[1] - 1, parts[2]);
    }

    function formatTMDBDate(dateStr) {
      return `${days[strToDate(dateStr).getDay()]}, ${dateStr}`;
    }

    function getDaysTil(date) {
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const numDays = Math.floor((date - today) / (1000 * 3600 * 24));
      return `${numDays} day${numDays === 1 ? "" : "s"}`;
    }

    function setupClickEvents() {
      $(".expander").click(function () {
        $(this).parent().removeClass("closed");
      });

      $(".hide-show").click(function () {
        var thisBtn = $(this);
        var show = thisBtn.attr("data-show");
        var jid = thisBtn.attr("data-jellyfin-id");
        var action = thisBtn.attr("data-action");

        // send req to server to ignore this. when done, remove this item's parent show-row
        var ignoreShow = async function () {
          var response = await fetch("./set-ignored", {
            body: JSON.stringify({
              jellyfinId: jid,
              show,
              action,
            }),
            headers: {
              "Content-Type": "application/json",
            },
            method: "POST",
          });

          if (response.status !== 200) {
            window.alert("ERROR IGNORING SHOW! SEE CONSOLE!");
            var output = await response.text();
            console.log(output);
          } else {
            thisBtn.closest(".show-row").remove();
          }
        };

        ignoreShow();
      });

      $("#clear-ignored").click(function () {
        var clearIgnored = async function () {
          if (!window.confirm("Really clear ignored shows list?")) {
            return;
          }

          var response = await fetch("./clear-ignored", {
            headers: {
              "Content-Type": "application/json",
            },
            method: "POST",
          });

          if (response.status !== 200) {
            window.alert("ERROR CLEARING IGNORED LIST! SEE CONSOLE!");
            var output = await response.text();
            console.log(output);
          } else {
            window.location.reload();
          }
        }
      });

      $(".edit-counting").click(function () {
        var recountFormData = {
          jellyfinId: $(this).attr("data-jellyfin-id"),
          show: $(this).attr("data-show"),
        }

        $(".recount-modal").css("display", "flex");
        $("#recount-show-name").text(recountFormData.show);
        $("#btn-recount-save").attr("data-show", recountFormData.show);
        $("#btn-recount-save").attr("data-jellyfin-id", recountFormData.jellyfinId);

        console.log({
          recountOverrides,
          jellyfinId: recountFormData.jellyfinId
        })

        var recountSeasonNums = recountOverrides
          .find(x => x.id.toString() === recountFormData.jellyfinId.toString())
          ?.recountOverride || "";

        $("#recount-show-season-counts").val(recountSeasonNums).focus();
      });

      $("#btn-recount-cancel").click(function () {
        $(".recount-modal").css("display", "none");
      });

      $("#btn-recount-save").click(function () {
        var btn = $(this);
        var show = btn.attr("data-show");
        var jid = btn.attr("data-jellyfin-id");
        var action = "save";
        var recountOverride = $("#recount-show-season-counts").val().trim();

        if (!recountOverride.match(/^\d+(,\d+)*$/)) {
          alert("Invalid recount override format. Must be numbers separated by commas. (e.g. \"12,14\" or \"12\")");
          return;
        }

        var saveOverride = async function () {
          var response = await fetch("./save-recount-override", {
            body: JSON.stringify({
              jellyfinId: jid,
              show,
              action,
              recountOverride,
            }),
            headers: {
              "Content-Type": "application/json",
            },
            method: "POST",
          });

          if (response.status !== 200) {
            window.alert("ERROR SAVING RECOUNT OVERRIDE! SEE CONSOLE!");
            var output = await response.text();
            console.log(output);
          } else {
            window.location.reload();
          }
        };

        saveOverride();
      });

      $("#btn-recount-delete").click(function () {
        var btn = $("#btn-recount-save");
        var show = btn.attr("data-show");
        var jid = btn.attr("data-jellyfin-id");
        var action = "delete";
        var recountOverride = $("#recount-show-season-counts").val().trim();

        if (!recountOverride.match(/^\d+(,\d+)*$/)) {
          alert("Invalid recount override format. Must be numbers separated by commas. (e.g. \"12,14\" or \"12\")");
          return;
        }

        var saveOverride = async function () {
          var response = await fetch("./save-recount-override", {
            body: JSON.stringify({
              jellyfinId: jid,
              show,
              action,
              recountOverride,
            }),
            headers: {
              "Content-Type": "application/json",
            },
            method: "POST",
          });

          if (response.status !== 200) {
            window.alert("ERROR SAVING RECOUNT OVERRIDE! SEE CONSOLE!");
            var output = await response.text();
            console.log(output);
          } else {
            window.location.reload();
          }
        };

        saveOverride();
      });
    }
  </script>
</head>

<body>
  <div class="page">
    <div class="header">
      <a href="../episodes">Re-run report</a>
      <div>Last run: <span id="last-run-date"></span></div>
    </div>

    <h1>New Episodes</h1>

    <div class="body" id="available-episodes"></div>

    <h1>Upcoming Episodes</h1>

    <div class="body" id="upcoming-episodes"></div>

    <h1>Ended Shows (Detected During Last Run)</h1>

    <div class="body closed" id="ended-shows">
      <div class="expander">+ Expand +</div>
    </div>

    <h1>Last Run Errors</h1>

    <div class="body" id="last-run-errors"></div>

    <h1>Ignored Shows <span id="clear-ignored" class="clickable">üëÅ</span></h1>

    <div class="body closed" id="ignored-shows">
      <div class="expander">+ Expand +</div>
    </div>
  </div>

  <div class="recount-modal">
    <div class="recount-dark"></div>
    <div class="recount-form">
      <span id="recount-show-name"></span>
      <b><label>Season Episode Counts</label></b>
      <input type="text" id="recount-show-season-counts" />
      <i>"12,12,14" means S01 has 12 eps, S02 has 12 eps, S03 has 14 eps. Omit the current season.</i>
      <i>Example: Frieren has 2 seasons.
        The first season has 12 episodes.
        The second has ?? episodes (ongoing).
        The Movie DB reports only 1 season, though, with the newest being 1x14.
        However, NYAA reports the newest episode being 2x02.
        They disagree on how many seasons the show has.
        To fix this, enter "12" here and save.
        This will tell the torrent links to show 2x02 instead of 1x14.
        Later, when season 2 concludes, come back and change this to "12,12" so that the links start using S03 instead.
      </i>
      <div style="text-align: right">
        <button id="btn-recount-delete" style="background-color: red; color: white;">Delete</button>
        &nbsp;
        <button id="btn-recount-cancel">Cancel</button>
        &nbsp;
        <button id="btn-recount-save">Save</button>
      </div>
    </div>
  </div>
</body>

</html>